# Usage guide

This page covers first-run setup, common merge patterns, and practical troubleshooting for svx.

For parameter details and all options, refer to:

- [Tuning and defaults](tuning.md)
- [TR containment](tr_containment.md)
- [Output interpretation](output.md)
- [Merge constraints](merge_constraints.md)
- [Full CLI reference (generated)](cli.md)

## Prerequisites

- Download the [latest svx binary](https://github.com/PacificBiosciences/svx/releases) or [clone](https://github.com/PacificBiosciences/svx) and build with `cargo build --release` (Rust >= `1.85.0`)
- Two or more single-sample VCF files generated by [sawfish](https://github.com/PacificBiosciences/sawfish)
- Input files must be BGZF-compressed VCF/BCF (for example, `.vcf.gz` or `.bcf.gz`) and indexed (`.tbi` or `.csi`)
- Sample names must be unique across all input VCFs
- Optional: tandem-repeat BED (for `--trs`), for example, catalogs linked in the [TRGT](https://github.com/PacificBiosciences/trgt?tab=readme-ov-file#repeat-catalogs) repository

## Quick start

Merge two VCFs and write uncompressed VCF to stdout:

```bash
./svx merge --vcf data/vcf_1.vcf.gz data/vcf_2.vcf.gz
```

Write to a file (format inferred from the filename unless overridden):

```bash
# uncompressed VCF
./svx merge --vcf data/vcf_1.vcf.gz data/vcf_2.vcf.gz -o out.vcf
# compressed VCF
./svx merge --vcf data/vcf_1.vcf.gz data/vcf_2.vcf.gz -o out.vcf.gz
```

## Input handling

Inputs can be provided directly or with a file containing file lists:

- `--vcf <VCF>...` accepts one or more paths (as well as globbing patterns)
- `--vcf-list <FILE>` reads one path per line

For `--vcf-list`, empty lines and lines beginning with `#` are ignored. Every other line is treated as a required path. If any listed file does not exist, svx exits immediately with an error. If all lines are empty/commented, svx exits with "No VCF paths found in the input file". By default, svx requires at least two input files. If you intentionally want to run with a single VCF, add `--force-single`.

## Use a TOML config for flags

For ease, users can place merge and tuning options in a TOML file while keeping file paths on the command line:

```bash
./svx merge --vcf data/*.vcf.gz --config config/merge.defaults.toml -o out.vcf.gz
```

Note that CLI flags will override config values when both are set. A baseline configuration that matches default behavior is provided as config/merge.defaults.toml. Config keys use snake_case and correspond to the long-form CLI flags. Relative paths in config values (for example `trs`) are resolved relative to the config fileâ€™s directory. Example:

```toml
threads = 8
io_threads = 4
contig = ["chr1", "chr2"]
svtype = ["ALL", "CNV"]
max_dist = 1000
min_sequence_similarity = 0.8
min_size_similarity = 0.7
merge_constraint = "bbox_diameter"
```

## Output controls

- `-o, --output` sets an output path. If omitted, output is written to stdout
- `-O, --output-type` overrides format inference (`u|b|v|z`)
- `--print-header` prints the merged header and exits
- `--no-version` omits `##svxVersion` and `##svxCommand` header lines

## Scoping a run

You can restrict work to a subset of the genome by contig and/or by coordinate ranges.

To filter by contig:

```bash
./svx merge --vcf data/*.vcf.gz --contig chr1
./svx merge --vcf data/*.vcf.gz --contig chr1,chr2,chrX
```

To filter by position(s):

```bash
./svx merge --vcf data/*.vcf.gz --target-positions "(chr1:50000-100000),(chr5:100000-200000)"
./svx merge --vcf data/*.vcf.gz --target-positions "(chr1:100000),(chr6:55000)"
```

The position syntax is (`contig:start[-end]`). Coordinates provided on the CLI are interpreted as 1-based, with inclusive endpoints for ranges. Internally, svx converts these inputs into 0-based intervals. For non-BND records, filtering is applied using the record POS (not END). With strict `--contig` or `--target-positions` filtering, one breakend of a BND pair can fall outside the selected scope. This produces orphan breakends, which are dropped.

## Select SV classes

Use `--svtype` to include only specific SV classes:

```bash
# insertions only
./svx merge --vcf data/*.vcf.gz --svtype INS
# deletions and duplications
./svx merge --vcf data/*.vcf.gz --svtype DEL,DUP
# CNV only
./svx merge --vcf data/*.vcf.gz --svtype CNV
```

The default is `--svtype ALL`, which includes `INS`,`DEL`,`INV`,`DUP`,`BND`. `CNV` is excluded from `ALL` and must be requested explicitly (for example, `--svtype ALL,CNV`).

For `--svtype CNV`, svx treats CNV records as copy-number loci across samples. A merged CNV group can include both loss-like (`DEL`) and gain-like (`DUP`) member records from different samples; when that happens, output is normalized to `SVTYPE=CNV` with `ALT=<CNV>`. DEL-only or DUP-only CNV groups keep `SVTYPE=DEL`/`<DEL>` or `SVTYPE=DUP`/`<DUP>` respectively. See [Output interpretation](output.md) for details.

## Parallelism and queues

SVX parallelizes at two levels, first across `(contig, SVTYPE)` blocks with `-t/--threads` worker threads then within a block via independent shard merging (disabled with `--no-shard`). Tuning guidance is in [Tuning and defaults](tuning.md).

## Progress display

The progress UI is shown only when all of the following are true: 1. stderr is an interactive terminal (TTY), logging is not debug or trace level, progress has not been disabled. By setting `--progress`, progress is forced in eligible environments and `--no-progress` always disables it.

## Diagnostics dump output

Use `--dump-path <file>` to write merge diagnostics to a TSV file. SVX writes three record types:

- `kd_coord`: KD-tree coordinate rows for each input variant.
- `group_variant`: merged-group membership rows.
- `group_size_count`: summary counts by merged-group size.

## Tandem repeats

Provide `--trs <bed>` to enable TR annotation and TR-specific merge behavior. TR containment currently applies to `INS` and `DEL` only. Use `--filter-tr-contained` to drop TR-contained calls entirely (they will not contribute to merging and will not appear in output). This option is only meaningful when `--trs` is provided. The TR BED format follows the TRGT repeat-catalog BED configuration specification: 4 columns (`chrom`, `start`, `end`, `info`), with `info` containing semicolon-delimited key/value entries including at least `ID=<repeat_id>` and `MOTIFS=<motif1[,motif2,...]>`. For the containment rules and TR-specific thresholds, see [TR containment](tr_containment.md). Using `--trs` can significantly increase merge runtime (~3x slow-down) because svx performs additional TR-aware checks during candidate evaluation.

## Troubleshooting

### Too many open files

If SVX fails with errors like `Too many open files`, increase your shell file descriptor limit and rerun after setting:

```bash
ulimit -n 8192
```

### Input VCF cannot be read or fetched

Verify that each input is BGZF-compressed VCF/BCF (`.vcf.gz`/`.bcf.gz`), indexed (`.tbi` or `.csi`), and coordinate-sorted consistently with the index. Problems related to this are often stale or mismatched index files after rewriting an input file.

### Inconsistent contig definitions across files

SVX requires compatible contig definitions across all inputs. If the same contig ID appears with different `length` values in different input headers, svx exits with an error. Regenerate or normalize headers so contig `ID/length` definitions match before merging.

### Duplicate sample IDs across files

SVX expects unique sample names across inputs. If duplicates exist, rename samples upstream and regenerate the input VCFs.

### `--target-positions` parse errors

Accepted forms are `(contig:start)`, `(contig:start-end)` or comma-separated tuples, e.g. `(chr1:1000),(chr2:2000-3000)`. Note that coordinates are 1-based in CLI input and must be positive.

### Missing BND mate warnings

Warnings about dropped orphan breakends indicate that a breakend's referenced mate record was not found in the selected input scope, and svx drops that orphan. This typically arises from the upstream callset or from scoping options that exclude one mate of a breakend pair. If a BND record is missing the `INFO/MATEID` field itself, that is a hard parse error and svx exits.
